(()=>{"use strict";new class{constructor(){this.currentUser=null,this.apiEndpoint="/api/journal",this.init()}init(){document.addEventListener("DOMContentLoaded",(()=>{this.checkAuthentication(),this.setupEventListeners(),this.setupTextareaAutoResize()}))}checkAuthentication(){if(this.currentUser=localStorage.getItem("currentUser")?JSON.parse(localStorage.getItem("currentUser")):null,!this.currentUser)return alert("Silakan login untuk mengakses Journaling."),void(window.location.href="login.html");const e=document.getElementById("btn-logout");e&&e.classList.remove("d-none")}setupEventListeners(){const e=document.getElementById("journaling-form");e&&e.addEventListener("submit",(e=>this.handleSubmit(e)));const t=document.getElementById("btn-logout");t&&t.addEventListener("click",(()=>this.handleLogout()));const n=document.getElementById("journal-entry");n&&(n.addEventListener("input",(()=>this.saveDraft())),this.loadDraft())}setupTextareaAutoResize(){const e=document.getElementById("journal-entry");e&&e.addEventListener("input",(function(){this.style.height="auto",this.style.height=Math.max(200,this.scrollHeight)+"px"}))}async handleSubmit(e){e.preventDefault();const t=document.getElementById("submit-btn"),n=t.querySelector(".btn-text"),a=document.getElementById("journal-entry").value.trim(),s=document.getElementById("success-message");if(this.validateEntry(a)){this.setLoadingState(t,n,!0),s.classList.add("d-none");try{const e=await this.submitJournal(a);this.handleSuccessfulSubmission(e),document.getElementById("journal-entry").value="",this.clearDraft(),s.classList.remove("d-none")}catch(e){this.handleSubmissionError(e)}finally{this.setLoadingState(t,n,!1)}}}validateEntry(e){return e?e.length<10?(alert("Jurnal terlalu pendek. Harap tulis minimal 10 karakter."),!1):!(e.length>5e3&&(alert("Jurnal terlalu panjang. Maksimal 5000 karakter."),1)):(alert("Harap isi jurnal sebelum mengirim."),!1)}async submitJournal(e){const t={journal_text:e,user_id:this.currentUser?.id||"anonymous",timestamp:(new Date).toISOString(),source:"web_app",metadata:{session_id:this.generateSessionId(),user_agent:navigator.userAgent,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}};return this.simulateMLAnalysis(t)}async simulateMLAnalysis(e){return await new Promise((e=>setTimeout(e,1500))),{sentiment:this.analyzeSentiment(e.journal_text),emotions:this.extractEmotions(e.journal_text),stress_level:this.assessStressLevel(e.journal_text),confidence:.3*Math.random()+.7,keywords:this.extractKeywords(e.journal_text),timestamp:(new Date).toISOString()}}analyzeSentiment(e){const t=e.toLowerCase(),n=["happy","joy","good","great","amazing","wonderful","excited","bahagia","senang","gembira"].filter((e=>t.includes(e))).length,a=["sad","angry","frustrated","stressed","worried","anxious","sedih","marah","stress","khawatir"].filter((e=>t.includes(e))).length;return n>a?"positive":a>n?"negative":"neutral"}extractEmotions(e){const t={happy:["happy","joy","excited","bahagia","senang","gembira"],sad:["sad","depressed","down","sedih","murung"],angry:["angry","frustrated","annoyed","marah","kesal"],anxious:["anxious","worried","nervous","cemas","khawatir"],calm:["calm","peaceful","relaxed","tenang","damai"]},n=e.toLowerCase(),a=[];for(const[e,s]of Object.entries(t))s.some((e=>n.includes(e)))&&a.push(e);return a.length>0?a:["neutral"]}assessStressLevel(e){const t=e.toLowerCase(),n=["stress","overwhelmed","pressure","deadline","busy","tired","exhausted","tertekan","lelah","capek"].filter((e=>t.includes(e))).length;return n>=3?"high":n>=1?"moderate":"low"}extractKeywords(e){const t=e.toLowerCase().split(/\s+/),n=["the","a","an","and","or","but","in","on","at","to","for","of","with","by","yang","dan","di","ke","dari","untuk"],a=t.filter((e=>e.length>3&&!n.includes(e)&&/^[a-zA-Z]+$/.test(e))),s={};return a.forEach((e=>{s[e]=(s[e]||0)+1})),Object.entries(s).sort((([,e],[,t])=>t-e)).slice(0,5).map((([e])=>e))}handleSuccessfulSubmission(e){localStorage.setItem("lastJournalAnalysis",JSON.stringify({...e,journal_text:document.getElementById("journal-entry").value.trim(),submission_timestamp:(new Date).toISOString()})),this.updateJournalSummary(e),console.log("Journal analysis completed:",e)}updateJournalSummary(e){const t=`journal_summary_${this.currentUser.id}`;let n=JSON.parse(localStorage.getItem(t))||{total_entries:0,sentiment_history:[],stress_trends:[],last_updated:null};n.total_entries+=1,n.sentiment_history.push({sentiment:e.sentiment,date:(new Date).toISOString().split("T")[0]}),n.stress_trends.push({level:e.stress_level,date:(new Date).toISOString().split("T")[0]}),n.last_updated=(new Date).toISOString();const a=new Date;a.setDate(a.getDate()-30);const s=a.toISOString().split("T")[0];n.sentiment_history=n.sentiment_history.filter((e=>e.date>=s)),n.stress_trends=n.stress_trends.filter((e=>e.date>=s)),localStorage.setItem(t,JSON.stringify(n))}handleSubmissionError(e){console.error("Error submitting journal:",e);const t=this.getErrorMessage(e);alert(t)}getErrorMessage(e){return e.message.includes("network")||e.message.includes("fetch")?"Koneksi internet bermasalah. Silakan periksa koneksi Anda dan coba lagi.":e.message.includes("unauthorized")||e.message.includes("401")?"Sesi Anda telah berakhir. Silakan login kembali.":e.message.includes("rate limit")?"Terlalu banyak permintaan. Silakan tunggu beberapa saat sebelum mencoba lagi.":"Terjadi kesalahan saat mengirim jurnal. Silakan coba lagi."}setLoadingState(e,t,n){e.disabled=n,t.innerHTML=n?'<span class="loading"></span>Menganalisis...':"Submit"}saveDraft(){const e=document.getElementById("journal-entry");if(e&&e.value.trim()){const t=`journal_draft_${this.currentUser.id}`;localStorage.setItem(t,JSON.stringify({text:e.value,timestamp:(new Date).toISOString()}))}}loadDraft(){const e=`journal_draft_${this.currentUser.id}`,t=localStorage.getItem(e);if(t){const n=JSON.parse(t),a=document.getElementById("journal-entry");new Date-new Date(n.timestamp)<864e5&&a?(a.value=n.text,this.showDraftNotification()):localStorage.removeItem(e)}}clearDraft(){const e=`journal_draft_${this.currentUser.id}`;localStorage.removeItem(e)}showDraftNotification(){const e=document.createElement("div");e.className="draft-notification",e.innerHTML='\n      <div class="alert alert-info alert-dismissible fade show" role="alert">\n        üìù Draft tersimpan telah dimuat\n        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n      </div>\n    ';const t=document.getElementById("journaling-form");t.insertBefore(e,t.firstChild),setTimeout((()=>{e.parentNode&&e.remove()}),5e3)}handleLogout(){confirm("Apakah Anda yakin ingin keluar?")&&(localStorage.removeItem("currentUser"),localStorage.removeItem("authToken"),this.clearDraft(),window.location.href="login.html")}generateSessionId(){return"session_"+Math.random().toString(36).substr(2,9)+"_"+Date.now()}getAuthToken(){return localStorage.getItem("authToken")||""}trackJournalEvent(e,t={}){"undefined"!=typeof gtag&&gtag("event",e,{event_category:"journaling",event_label:this.currentUser?.id||"anonymous",...t}),console.log("Journal Event:",e,t)}async makeAPIRequest(e,t={}){const n={headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getAuthToken()}`,"X-User-ID":this.currentUser?.id||"anonymous"}},a={...n,...t,headers:{...n.headers,...t.headers}};try{const t=await fetch(`${this.apiEndpoint}${e}`,a);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(e){throw console.error("API Request failed:",e),e}}async submitJournalToML(e){try{return await this.makeAPIRequest("/analyze",{method:"POST",body:JSON.stringify(e)})}catch(e){throw console.error("ML API Error:",e),e}}async getJournalHistory(e=10){try{return(await this.makeAPIRequest(`/history?limit=${e}`)).data||[]}catch(e){return console.error("Failed to fetch journal history:",e),[]}}async getAnalyticsSummary(){try{return(await this.makeAPIRequest("/analytics/summary")).data||{}}catch(e){return console.error("Failed to fetch analytics summary:",e),{}}}sanitizeInput(e){return e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<[^>]+>/g,"").trim()}validateTextLength(e,t=10,n=5e3){return e.length>=t&&e.length<=n}detectSpam(e){return[/(.)\1{10,}/g,/https?:\/\/[^\s]+/g,/\b\d{4,}\b/g].some((t=>t.test(e)))}setupAccessibility(){const e=document.getElementById("journal-entry");if(e){e.setAttribute("aria-describedby","journal-help");const t=document.createElement("div");t.id="journal-help",t.className="form-text",t.textContent="Bagikan perasaan dan pengalaman Anda dengan bebas. Tulisan Anda akan dianalisis untuk memberikan wawasan tentang kondisi mental Anda.",e.parentNode.appendChild(t)}}setupKeyboardShortcuts(){document.addEventListener("keydown",(e=>{if((e.ctrlKey||e.metaKey)&&"Enter"===e.key){e.preventDefault();const t=document.getElementById("journaling-form");t&&t.dispatchEvent(new Event("submit"))}(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),this.saveDraft(),this.showNotification("Draft tersimpan","success"))}))}showNotification(e,t="info"){const n=document.createElement("div");n.className=`alert alert-${t} alert-dismissible fade show notification-toast`,n.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      z-index: 9999;\n      min-width: 300px;\n    ",n.innerHTML=`\n      ${e}\n      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n    `,document.body.appendChild(n),setTimeout((()=>{n.parentNode&&n.remove()}),3e3)}}})();